<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>typing-ru sample</title>

</head>
<body>
Q: <div id="question"></div>
<div id="typed" style="color: red;"></div>
<div id="answer"></div>
Time: <div id="sec"></div>

<script type="text/javascript">

     var rusKeycodes = new Array();
     rusKeycodes = {
      65:"ф",
      66:"и",
      67:"с",
      68:"в",
      69:"у",
      70:"а",
      71:"п",
      72:"р",
      73:"ш",
      74:"о",
      75:"л",
      76:"д",
      77:"ь",
      78:"т",
      79:"щ",
      80:"з",
      81:"й",
      82:"к",
      83:"ы",
      84:"е",
      85:"г",
      86:"м",
      87:"ц",
      88:"ч",
      89:"н",
      90:"я",
      48:"0",
      49:"1",
      50:"2",
      51:"3",
      52:"4",
      53:"5",
      54:"6",
      55:"7",
      56:"8",
      57:"9",
      186:"э",
      187:"ж",
      188:"б",
      189:"-",
      190:"ю",
      191:".",
      219:"х",
      221:"ъ",
      222:"=",
      32:" ",
     "s65":"Ф",
      "s66":"И",
      "s67":"С",
      "s68":"В",
      "s69":"У",
      "s70":"А",
      "s71":"П",
      "s72":"Н",
      "s73":"Ш",
      "s74":"О",
      "s75":"Л",
      "s76":"Д",
      "s77":"Ь",
      "s78":"Т",
      "s79":"Щ",
      "s80":"З",
      "s81":"Й",
      "s82":"К",
      "s83":"Ы",
      "s84":"Е",
      "s85":"Г",
      "s86":"М",
      "s87":"Ц",
      "s88":"Ч",
      "s89":"Н",
      "s90":"Я",
      "s48":")",
      "s49":"!",
      "s222":"?",
      "s51":"№",
      "s52":";",
      "s53":"%",
      "s54":":",
      "s56":"*",
      "s57":"(",
      "s189":"_",
      "s187":"+",
      "s221":"/",
      "s188":",",
      "s50":'"'
      };


      var rusAlphabet = new Array();


      //rusKeycodes.forEach(function(value){
        for (var key in rusKeycodes){
          var newkey = rusKeycodes[key];
          rusAlphabet[newkey] = key;
        }
        
      //});


     var word = 'У метро "Дмитровская" обрушился подземный переход'; //問題
     var keycodes = new Array();
     wordtoArray = word.split("");
     wordtoArray.forEach(function(value) { //convert to keycode array
      if(value=='"'){
        value = "?"
      }
        keycodes.push(rusAlphabet[value]);
      
     });
     console.log(keycodes);

     var charnum = 0;
     var maxchar = keycodes.length; //問題の文字列の長さを測定
     window.onload = run(); //start count

      var question = document.getElementById("question");
      question.innerHTML = word; //Show question
      var target = document.getElementById("answer");
      var typed = document.getElementById("typed");
      var timecount = document.getElementById("timecount");
      var typedtxt = new Array(); //Show typed text by user

      //timecount
      var startTime,
      timerId;

      function run() {
        startTime = (new Date()).getTime(); //set start time
        timer();
      }

      function stop() { //stop timecount
        clearTimeout(timerId);
      }

      function timer() {
      //  document.getElementById('sec').innerHTML = (((new Date()).getTime() - startTime) / 1000).toFixed(2);
        timerId = setTimeout(function() { 
          timer(); //0.1 sec ごとにtimer function を実行。これでタイマーが動く。
        }, 100);
    
      }


      document.onkeydown = function(e){
        var currentKey = e.keyCode;
        // Shiftキーの押下状態
        var onShiftkey = e.shiftKey;
        // Ctrlキーの押下状態
        var ctrl_key = e.ctrlKey;
        // Altキーの押下状態
        var alt_key = e.altKey;

        if(onShiftkey == true){
          currentKey = "s"+currentKey;
        }

        if(keycodes[charnum] == currentKey) { //good typed
          target.innerHTML = "OK" + currentKey;
          charnum += 1;
          addchar = word.substr(0, charnum); //get character typed by user
          typed.innerHTML = addchar; 

            if (charnum == maxchar){ //when last character
              target.innerHTML = "Clear" + currentKey;
              charnum = 0;
              stop();
            }
        } else if (currentKey != "s16") { //bad typed
          target.innerHTML = "NG" + currentKey;
        }

        };

</script>

</body>
</html>